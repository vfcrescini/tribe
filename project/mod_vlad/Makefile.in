# This file is part of PolicyUpdater.
#
# Copyright (C) 2003, 2004 University of Western Sydney
# by Vino Fernando Crescini <jcrescin@cit.uws.edu.au>
#
# PolicyUpdater is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# PolicyUpdater is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with PolicyUpdater; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

TOPSRCDIR = @top_srcdir@
CC = @CC@
LEX = @LEX@
YACC = @YACC@
CFLAGS = @CFLAGS@
LDFLAGS = @LDFLAGS@
DEBUG = @DEBUG@
STRIP = @STRIP@
PICFLAG = @PICFLAG@
VERSION = @VERSION@
LIBS = mod_vlad.so
OBJECTS = mod_vlad.o policy_p.o policy_s.o util.o admin.o proc.o
TEMP1 = lex.*.c *.tab.c *.tab.h
TEMP2 = config.h

.PHONY :    \
  all       \
  clean     \
  distclean \
  $(NULL)

all : $(LIBS)

mod_vlad.so : $(OBJECTS)
	$(CC) $(CFLAGS) $(PICFLAG) $(LDFLAGS) -shared -Wl,-soname,$(@).`echo $(VERSION) | cut -d. -f1` -o $(@) $(^) -lvlad
ifndef DEBUG
  ifdef STRIP
	strip $(@)
  endif
endif

mod_vlad.o : util.h admin.h mod_vlad.h mod_vlad.c
	$(CC) $(CFLAGS) $(PICFLAG) -o $(@) -c mod_vlad.c

util.o : mod_vlad.h util.h util.c
	$(CC) $(CFLAGS) $(PICFLAG) -o $(@) -c util.c

admin.o : mod_vlad.h admin.h admin.c
	$(CC) $(CFLAGS) $(PICFLAG) -o $(@) -c admin.c

proc.o : mod_vlad.h proc.h proc.c
	$(CC) $(CFLAGS) $(PICFLAG) -o $(@) -c proc.c

policy_p.o : policy.tab.h policy.tab.c
	$(CC) $(CFLAGS) $(PICFLAG) -o $(@) -c policy.tab.c

policy_s.o : policy.tab.h lex.policy.c
	$(CC) $(CFLAGS) $(PICFLAG) -o $(@) -c lex.policy.c

policy.tab.h : policy.y
	$(YACC) -b policy -p policy -d policy.y

policy.tab.cpp : policy.y
	$(YACC) -b policy -p policy policy.y

lex.policy.c : policy.l
	$(LEX) -Ppolicy policy.l

clean :
	$(RM) $(OBJECTS) $(TEMP1)

distclean : clean
	$(RM) -r $(LIBS) $(TEMP2) Makefile config.status config.log autom4te.cache
